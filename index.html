
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>ASM Ä°laÃ§ Takip â€“ Liste Ãœzerinden GÃ¼venli DÃ¼ÅŸÃ¼m (CanlÄ± GÃ¼ncellenen)</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f9fbfc; padding: 20px; }
    h1 { color: #2C3E50; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #d5f3d5; }
    button { padding: 5px 10px; margin: 3px; cursor: pointer; }
    .form-section { margin-top: 30px; background: #eef; padding: 15px; border-radius: 8px; display: none; }
    .highlight { background: #d0f0d0; }
  </style>
</head>
<body>

<h1>ASM Ä°laÃ§ Takip Sistemi â€“ Liste Ãœzerinden DÃ¼ÅŸÃ¼m + CanlÄ± GÃ¼ncelleme</h1>

<div id="tableContainer">â³ Ä°laÃ§lar yÃ¼kleniyor...</div>

<div id="formSection" class="form-section">
  <h3>SeÃ§ilen Ä°laÃ§: <span id="selectedDrugName"></span></h3>
  <input type="number" id="removeQty" placeholder="KaÃ§ adet dÃ¼ÅŸÃ¼lecek?" required />
  <input type="text" id="givenTo" placeholder="Verilen Hasta" required />
  <input type="text" id="givenDate" placeholder="VeriliÅŸ Tarihi (Ã¶rn: 29.10.2025)" required />
  <button onclick="confirmAndSubmit()">ğŸ’Š Stoktan DÃ¼ÅŸ</button>
  <div id="statusMsg"></div>
</div>

<script>
const api = "https://script.google.com/macros/s/AKfycbx7JxLMlY6F08ltji1LEfXD_uumqaxIjq3l4TfrbichvzPD0sFm-Ki3fGw_aCyLhTc/exec";
let selectedRow = null;

async function loadTable() {
  const res = await fetch(api + '?t=' + Date.now());
  const data = await res.json();

  let html = `<table><thead>
    <tr><th>Ä°laÃ§ AdÄ±</th><th>SKT</th><th>Etken Madde</th><th>Stok</th><th>Ä°ÅŸlem</th></tr>
  </thead><tbody>`;

  data.forEach((row, index) => {
    if (row["Ä°laÃ§ AdÄ± / Dozaj"] && row["Stok Adedi"]) {
      const rowId = `row${index}`;
      html += `<tr id="${rowId}">
        <td>${row["Ä°laÃ§ AdÄ± / Dozaj"]}</td>
        <td>${row["Son KullanÄ±m Tarihi"]}</td>
        <td>${row["Etken Madde / Dozaj"]}</td>
        <td>${row["Stok Adedi"]}</td>
        <td><button onclick='selectRow(${JSON.stringify(row)}, "${rowId}")'>Stoktan DÃ¼ÅŸ</button></td>
      </tr>`;
    }
  });

  html += "</tbody></table>";
  document.getElementById("tableContainer").innerHTML = html;
}

function selectRow(row, rowId) {
  selectedRow = row;
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("highlight"));
  document.getElementById(rowId).classList.add("highlight");

  document.getElementById("selectedDrugName").innerText = row["Ä°laÃ§ AdÄ± / Dozaj"] + " / SKT: " + row["Son KullanÄ±m Tarihi"];
  document.getElementById("formSection").style.display = "block";
}

function confirmAndSubmit() {
  if (!selectedRow) return;
  const adet = parseInt(document.getElementById("removeQty").value);
  const hasta = document.getElementById("givenTo").value.trim();
  const tarih = document.getElementById("givenDate").value.trim();

  if (!adet || !hasta || !tarih) {
    alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
    return;
  }

  const kalan = parseInt(selectedRow["Stok Adedi"]) - adet;
  if (kalan < 0) {
    alert("âš ï¸ Bu kadar stok yok. LÃ¼tfen kontrol edin.");
    return;
  }

  const onay = confirm(`${selectedRow["Ä°laÃ§ AdÄ± / Dozaj"]} adlÄ± ilaÃ§tan ${adet} adet dÃ¼ÅŸÃ¼lecek. Emin misiniz?`);
  if (!onay) return;

  const body = {
    "Son KullanÄ±m Tarihi": selectedRow["Son KullanÄ±m Tarihi"],
    "Ä°laÃ§ AdÄ± / Dozaj": selectedRow["Ä°laÃ§ AdÄ± / Dozaj"],
    "Etken Madde / Dozaj": selectedRow["Etken Madde / Dozaj"],
    "Stok Adedi": kalan,
    "Ana Grup (ASTIM / KOAH vs)": selectedRow["Ana Grup (ASTIM / KOAH vs)"],
    "KÃœB / KT Linki": selectedRow["KÃœB / KT Linki"],
    "Verilen Tarih": tarih,
    "Verilen Hasta": hasta
  };

  fetch(api, {
    method: "POST",
    body: JSON.stringify(body)
  }).then(r => r.text()).then(msg => {
    document.getElementById("statusMsg").innerText = "âœ… " + msg;
    document.getElementById("formSection").style.display = "none";
    loadTable();
  });
}

loadTable();
</script>

</body>
</html>
